resources:
  repositories:
    - repository: owaspzp
      type: git
      name: kunalt/kunalt
      ref: refs/heads/main

trigger: none

stages:
- stage: 'buildstage'
  jobs:
  - job: 'buildjob'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - bash: |
        # Pull the nginx Docker image
        sudo docker pull nginx:latest
        # Run the nginx container
        sudo docker run -d -p 80:80 nginx
      displayName: 'Pull and Run nginx Container'

    - bash: |
        sudo chmod -R 777 ./
        sudo docker run --rm -v $(pwd):/zap/wrk/:rw -t owasp/zap2docker-stable zap-full-scan.py -t http://$(ip -f inet -o addr show docker0 | awk '{print $4}' | cut -d '/' -f 1):80 -x 'xml_report.xml'
        true
        ls
        pwd
        true
      displayName: 'Owasp Container Scan'
      
    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: |
          wget https://udomain.dl.sourceforge.net/project/saxon/Saxon-HE/10/Java/SaxonHE10-3J.zip
          unzip SaxonHE10-3J.zip 
          sleep 5
          mkdir $(System.DefaultWorkingDirectory)/tests/
          cp $(System.DefaultWorkingDirectory)/xml_report.xml $(System.DefaultWorkingDirectory)/tests/xml_report.xml
    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: 'java -jar saxon-he-10.3.jar -xsl:xml_to_nunit.xslt -s:$(System.DefaultWorkingDirectory)/tests/xml_report.xml -o:converted_report.xml'
      displayName: 'Report generation'


    # - powershell: |

    #     $XslPath = "/home/vsts/work/1/s/xml_to_nunit.xslt"
    #     $XmlInputPath = "/home/vsts/work/1/s/xml_report.xml"
    #     $XmlOutputPath = "/home/vsts/work/1/s/converted_report.xml"
    #     $XslTransform = New-Object System.Xml.Xsl.XslCompiledTransform
    #     $XslTransform.Load($XslPath)
    #     $XslTransform.Transform($XmlInputPath, $XmlOutputPath)
    #   displayName: 'PowerShell Script'


    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
        testResultsFormat: 'NUnit'
        testResultsFiles: 'converted_report.xml'